{"version":3,"file":"storage.js","sourceRoot":"","sources":["../../src/storage.ts"],"names":[],"mappings":";;;;;;;;;;;AAAA,OAAO,EAAE,OAAO,EAAE,MAAM,SAAS,CAAA;AAEjC,OAAO,EAAE,WAAW,EAAE,UAAU,EAAE,4BAA4B,EAAE,MAAM,aAAa,CAAA;AAEnF,OAAO,EAAE,OAAO,EAAE,YAAY,EAAE,MAAM,oBAAoB,CAAA;AAC1D,OAAO,EAAE,MAAM,EAAE,MAAM,gBAAgB,CAAA;AACvC,OAAO,EAAE,MAAM,EAAE,QAAQ,EAAE,MAAM,iBAAiB,CAAA;AAClD,OAAO,EAAE,MAAM,EAAE,MAAM,UAAU,CAAA;AAEjC,IAAM,KAAK,GAAG,+BAA+B,CAAA;AAC7C,sFAAsF;AACtF,IAAI,uBAAuB,GAAG,EAAE,CAAA;AAEhC,8CAA8C;AAC9C,MAAM,CAAC,IAAM,mBAAmB,GAAG;IAC/B,uBAAuB,GAAG,EAAE,CAAA;AAChC,CAAC,CAAA;AAED;;;;;;;;;;;;GAYG;AACH,MAAM,UAAU,2BAA2B,CAAC,QAAgB,EAAE,SAAoB;IAApB,0BAAA,EAAA,oBAAoB;IAC9E,IAAI,uBAAuB,EAAE;QACzB,OAAO,uBAAuB,CAAA;KACjC;IAED,IAAI,CAAC,SAAS,EAAE;QACZ,OAAO,EAAE,CAAA;KACZ;IACD,IAAI,CAAC,WAAW,EAAE,WAAW,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAC;QAAE,OAAO,EAAE,CAAA;IAE5D,IAAM,IAAI,GAAG,QAAQ,CAAC,KAAK,CAAC,GAAG,CAAC,CAAA;IAChC,IAAI,GAAG,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,MAAM,EAAE,CAAC,CAAC,CAAA,CAAC,iDAAiD;IACpF,IAAM,GAAG,GAAG,UAAU,GAAG,MAAM,EAAE,CAAA;IACjC,IAAM,CAAC,GAAG,IAAI,MAAM,CAAC,WAAW,GAAG,GAAG,GAAG,IAAI,CAAC,CAAA;IAE9C,OAAO,CAAC,uBAAuB,IAAI,GAAG,EAAE,EAAE;QACtC,IAAM,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAA;QAC3C,IAAM,oBAAoB,GAAG,GAAG,GAAG,aAAa,GAAG,SAAS,CAAA;QAE5D,oBAAoB;QACpB,SAAS,CAAC,MAAM,GAAG,oBAAoB,CAAA;QAEvC,IAAI,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,MAAM,CAAC,EAAE;YAC1B,iEAAiE;YACjE,SAAS,CAAC,MAAM,GAAG,oBAAoB,GAAG,WAAW,GAAG,KAAK,CAAA;YAC7D,uBAAuB,GAAG,SAAS,CAAA;SACtC;KACJ;IAED,OAAO,uBAAuB,CAAA;AAClC,CAAC;AAED,IAAM,kBAAkB,GAAG,iCAAiC,CAAA;AAC5D,IAAM,sBAAsB,GAAG,UAAC,QAAgB;IAC5C,IAAM,OAAO,GAAG,QAAQ,CAAC,KAAK,CAAC,kBAAkB,CAAC,CAAA;IAClD,OAAO,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,CAAA;AACpC,CAAC,CAAA;AAED,MAAM,UAAU,kBAAkB,CAAC,QAAgB,EAAE,eAAoC;IACrF,IAAI,eAAe,EAAE;QACjB,qDAAqD;QACrD,IAAI,gBAAgB,GAAG,2BAA2B,CAAC,QAAQ,CAAC,CAAA;QAE5D,IAAI,CAAC,gBAAgB,EAAE;YACnB,IAAM,aAAa,GAAG,sBAAsB,CAAC,QAAQ,CAAC,CAAA;YACtD,IAAI,aAAa,KAAK,gBAAgB,EAAE;gBACpC,MAAM,CAAC,IAAI,CAAC,8CAA8C,EAAE,aAAa,EAAE,gBAAgB,CAAC,CAAA;aAC/F;YACD,gBAAgB,GAAG,aAAa,CAAA;SACnC;QAED,OAAO,gBAAgB,CAAC,CAAC,CAAC,YAAY,GAAG,gBAAgB,CAAC,CAAC,CAAC,EAAE,CAAA;KACjE;IACD,OAAO,EAAE,CAAA;AACb,CAAC;AAED,iEAAiE;AACjE,MAAM,CAAC,IAAM,WAAW,GAAoB;IACxC,YAAY,EAAE,cAAM,OAAA,CAAC,CAAC,QAAQ,EAAV,CAAU;IAE9B,KAAK,EAAE,UAAU,GAAG;QAChB,MAAM,CAAC,KAAK,CAAC,qBAAqB,GAAG,GAAG,CAAC,CAAA;IAC7C,CAAC;IAED,GAAG,EAAE,UAAU,IAAI;QACf,IAAI,CAAC,QAAQ,EAAE;YACX,OAAM;SACT;QAED,IAAI;YACA,IAAM,MAAM,GAAG,IAAI,GAAG,GAAG,CAAA;YACzB,IAAM,EAAE,GAAG,QAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,MAAM,CAAC,UAAC,CAAC,IAAK,OAAA,CAAC,CAAC,MAAM,EAAR,CAAQ,CAAC,CAAA;YAC7D,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,EAAE,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;gBAChC,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC,CAAA;gBACb,OAAO,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,IAAI,GAAG,EAAE;oBACvB,CAAC,GAAG,CAAC,CAAC,SAAS,CAAC,CAAC,EAAE,CAAC,CAAC,MAAM,CAAC,CAAA;iBAC/B;gBACD,IAAI,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE;oBACzB,OAAO,kBAAkB,CAAC,CAAC,CAAC,SAAS,CAAC,MAAM,CAAC,MAAM,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC,CAAA;iBAClE;aACJ;SACJ;QAAC,OAAO,GAAG,EAAE,GAAE;QAChB,OAAO,IAAI,CAAA;IACf,CAAC;IAED,KAAK,EAAE,UAAU,IAAI;QACjB,IAAI,MAAM,CAAA;QACV,IAAI;YACA,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,CAAA;SACnD;QAAC,OAAO,GAAG,EAAE;YACV,OAAO;SACV;QACD,OAAO,MAAM,CAAA;IACjB,CAAC;IAED,GAAG,EAAE,UAAU,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,eAAe,EAAE,SAAS;QACxD,IAAI,CAAC,QAAQ,EAAE;YACX,OAAM;SACT;QACD,IAAI;YACA,IAAI,OAAO,GAAG,EAAE,EACZ,MAAM,GAAG,EAAE,CAAA;YAEf,IAAM,OAAO,GAAG,kBAAkB,CAAC,QAAQ,CAAC,QAAQ,CAAC,QAAQ,EAAE,eAAe,CAAC,CAAA;YAE/E,IAAI,IAAI,EAAE;gBACN,IAAM,IAAI,GAAG,IAAI,IAAI,EAAE,CAAA;gBACvB,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,OAAO,EAAE,GAAG,IAAI,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC,CAAA;gBACzD,OAAO,GAAG,YAAY,GAAG,IAAI,CAAC,WAAW,EAAE,CAAA;aAC9C;YAED,IAAI,SAAS,EAAE;gBACX,MAAM,GAAG,UAAU,CAAA;aACtB;YAED,IAAM,cAAc,GAChB,IAAI;gBACJ,GAAG;gBACH,kBAAkB,CAAC,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;gBACzC,OAAO;gBACP,wBAAwB;gBACxB,OAAO;gBACP,MAAM,CAAA;YAEV,kHAAkH;YAClH,IAAI,cAAc,CAAC,MAAM,GAAG,IAAI,GAAG,GAAG,EAAE;gBACpC,MAAM,CAAC,IAAI,CAAC,yCAAyC,GAAG,cAAc,CAAC,MAAM,CAAC,CAAA;aACjF;YAED,QAAQ,CAAC,MAAM,GAAG,cAAc,CAAA;YAChC,OAAO,cAAc,CAAA;SACxB;QAAC,OAAO,GAAG,EAAE;YACV,OAAM;SACT;IACL,CAAC;IAED,MAAM,EAAE,UAAU,IAAI,EAAE,eAAe;QACnC,IAAI;YACA,WAAW,CAAC,GAAG,CAAC,IAAI,EAAE,EAAE,EAAE,CAAC,CAAC,EAAE,eAAe,CAAC,CAAA;SACjD;QAAC,OAAO,GAAG,EAAE;YACV,OAAM;SACT;IACL,CAAC;CACJ,CAAA;AAED,IAAI,uBAAuB,GAAmB,IAAI,CAAA;AAElD,MAAM,CAAC,IAAM,UAAU,GAAoB;IACvC,YAAY,EAAE;QACV,IAAI,CAAC,OAAO,CAAC,uBAAuB,CAAC,EAAE;YACnC,OAAO,uBAAuB,CAAA;SACjC;QAED,IAAI,SAAS,GAAG,IAAI,CAAA;QACpB,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,EAAE;YACvB,IAAI;gBACA,IAAM,GAAG,GAAG,iBAAiB,EACzB,GAAG,GAAG,KAAK,CAAA;gBACf,UAAU,CAAC,GAAG,CAAC,GAAG,EAAE,GAAG,CAAC,CAAA;gBACxB,IAAI,UAAU,CAAC,GAAG,CAAC,GAAG,CAAC,KAAK,OAAO,EAAE;oBACjC,SAAS,GAAG,KAAK,CAAA;iBACpB;gBACD,UAAU,CAAC,MAAM,CAAC,GAAG,CAAC,CAAA;aACzB;YAAC,OAAO,GAAG,EAAE;gBACV,SAAS,GAAG,KAAK,CAAA;aACpB;SACJ;aAAM;YACH,SAAS,GAAG,KAAK,CAAA;SACpB;QACD,IAAI,CAAC,SAAS,EAAE;YACZ,MAAM,CAAC,KAAK,CAAC,wDAAwD,CAAC,CAAA;SACzE;QAED,uBAAuB,GAAG,SAAS,CAAA;QACnC,OAAO,SAAS,CAAA;IACpB,CAAC;IAED,KAAK,EAAE,UAAU,GAAG;QAChB,MAAM,CAAC,KAAK,CAAC,sBAAsB,GAAG,GAAG,CAAC,CAAA;IAC9C,CAAC;IAED,GAAG,EAAE,UAAU,IAAI;QACf,IAAI;YACA,OAAO,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,YAAY,CAAC,OAAO,CAAC,IAAI,CAAC,CAAA;SAC5C;QAAC,OAAO,GAAG,EAAE;YACV,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,CAAA;SACxB;QACD,OAAO,IAAI,CAAA;IACf,CAAC;IAED,KAAK,EAAE,UAAU,IAAI;QACjB,IAAI;YACA,OAAO,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,CAAA;SAChD;QAAC,OAAO,GAAG,EAAE;YACV,OAAO;SACV;QACD,OAAO,IAAI,CAAA;IACf,CAAC;IAED,GAAG,EAAE,UAAU,IAAI,EAAE,KAAK;QACtB,IAAI;YACA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,YAAY,CAAC,OAAO,CAAC,IAAI,EAAE,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC,CAAA;SAC5D;QAAC,OAAO,GAAG,EAAE;YACV,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,CAAA;SACxB;IACL,CAAC;IAED,MAAM,EAAE,UAAU,IAAI;QAClB,IAAI;YACA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,YAAY,CAAC,UAAU,CAAC,IAAI,CAAC,CAAA;SACxC;QAAC,OAAO,GAAG,EAAE;YACV,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,CAAA;SACxB;IACL,CAAC;CACJ,CAAA;AAED,sFAAsF;AACtF,yFAAyF;AACzF,oEAAoE;AACpE,IAAM,2BAA2B,GAAG,CAAC,WAAW,EAAE,UAAU,EAAE,4BAA4B,CAAC,CAAA;AAE3F,MAAM,CAAC,IAAM,oBAAoB,yBAC1B,UAAU,KACb,KAAK,EAAE,UAAU,IAAI;QACjB,IAAI;YACA,IAAI,MAAM,GAAe,EAAE,CAAA;YAC3B,IAAI;gBACA,4CAA4C;gBAC5C,MAAM,GAAG,WAAW,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,EAAE,CAAA;aACzC;YAAC,OAAO,GAAG,EAAE,GAAE;YAChB,IAAM,KAAK,GAAG,OAAO,CAAC,MAAM,EAAE,IAAI,CAAC,KAAK,CAAC,UAAU,CAAC,GAAG,CAAC,IAAI,CAAC,IAAI,IAAI,CAAC,CAAC,CAAA;YACvE,UAAU,CAAC,GAAG,CAAC,IAAI,EAAE,KAAK,CAAC,CAAA;YAC3B,OAAO,KAAK,CAAA;SACf;QAAC,OAAO,GAAG,EAAE;YACV,OAAO;SACV;QACD,OAAO,IAAI,CAAA;IACf,CAAC,EAED,GAAG,EAAE,UAAU,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,eAAe,EAAE,SAAS;QACxD,IAAI;YACA,UAAU,CAAC,GAAG,CAAC,IAAI,EAAE,KAAK,CAAC,CAAA;YAC3B,IAAM,2BAAyB,GAAwB,EAAE,CAAA;YACzD,2BAA2B,CAAC,OAAO,CAAC,UAAC,GAAG;gBACpC,IAAI,KAAK,CAAC,GAAG,CAAC,EAAE;oBACZ,2BAAyB,CAAC,GAAG,CAAC,GAAG,KAAK,CAAC,GAAG,CAAC,CAAA;iBAC9C;YACL,CAAC,CAAC,CAAA;YAEF,IAAI,MAAM,CAAC,IAAI,CAAC,2BAAyB,CAAC,CAAC,MAAM,EAAE;gBAC/C,WAAW,CAAC,GAAG,CAAC,IAAI,EAAE,2BAAyB,EAAE,IAAI,EAAE,eAAe,EAAE,SAAS,CAAC,CAAA;aACrF;SACJ;QAAC,OAAO,GAAG,EAAE;YACV,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,CAAA;SACxB;IACL,CAAC,EAED,MAAM,EAAE,UAAU,IAAI,EAAE,eAAe;QACnC,IAAI;YACA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,YAAY,CAAC,UAAU,CAAC,IAAI,CAAC,CAAA;YACrC,WAAW,CAAC,MAAM,CAAC,IAAI,EAAE,eAAe,CAAC,CAAA;SAC5C;QAAC,OAAO,GAAG,EAAE;YACV,UAAU,CAAC,KAAK,CAAC,GAAG,CAAC,CAAA;SACxB;IACL,CAAC,GACJ,CAAA;AAED,IAAM,aAAa,GAAe,EAAE,CAAA;AAEpC,qFAAqF;AACrF,MAAM,CAAC,IAAM,WAAW,GAAoB;IACxC,YAAY,EAAE;QACV,OAAO,IAAI,CAAA;IACf,CAAC;IAED,KAAK,EAAE,UAAU,GAAG;QAChB,MAAM,CAAC,KAAK,CAAC,uBAAuB,GAAG,GAAG,CAAC,CAAA;IAC/C,CAAC;IAED,GAAG,EAAE,UAAU,IAAI;QACf,OAAO,aAAa,CAAC,IAAI,CAAC,IAAI,IAAI,CAAA;IACtC,CAAC;IAED,KAAK,EAAE,UAAU,IAAI;QACjB,OAAO,aAAa,CAAC,IAAI,CAAC,IAAI,IAAI,CAAA;IACtC,CAAC;IAED,GAAG,EAAE,UAAU,IAAI,EAAE,KAAK;QACtB,aAAa,CAAC,IAAI,CAAC,GAAG,KAAK,CAAA;IAC/B,CAAC;IAED,MAAM,EAAE,UAAU,IAAI;QAClB,OAAO,aAAa,CAAC,IAAI,CAAC,CAAA;IAC9B,CAAC;CACJ,CAAA;AAED,IAAI,uBAAuB,GAAmB,IAAI,CAAA;AAClD,MAAM,CAAC,IAAM,4BAA4B,GAAG;IACxC,uBAAuB,GAAG,IAAI,CAAA;AAClC,CAAC,CAAA;AACD,8EAA8E;AAC9E,MAAM,CAAC,IAAM,YAAY,GAAoB;IACzC,YAAY,EAAE;QACV,IAAI,CAAC,OAAO,CAAC,uBAAuB,CAAC,EAAE;YACnC,OAAO,uBAAuB,CAAA;SACjC;QACD,uBAAuB,GAAG,IAAI,CAAA;QAC9B,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,EAAE;YACvB,IAAI;gBACA,IAAM,GAAG,GAAG,aAAa,EACrB,GAAG,GAAG,KAAK,CAAA;gBACf,YAAY,CAAC,GAAG,CAAC,GAAG,EAAE,GAAG,CAAC,CAAA;gBAC1B,IAAI,YAAY,CAAC,GAAG,CAAC,GAAG,CAAC,KAAK,OAAO,EAAE;oBACnC,uBAAuB,GAAG,KAAK,CAAA;iBAClC;gBACD,YAAY,CAAC,MAAM,CAAC,GAAG,CAAC,CAAA;aAC3B;YAAC,OAAO,GAAG,EAAE;gBACV,uBAAuB,GAAG,KAAK,CAAA;aAClC;SACJ;aAAM;YACH,uBAAuB,GAAG,KAAK,CAAA;SAClC;QACD,OAAO,uBAAuB,CAAA;IAClC,CAAC;IAED,KAAK,EAAE,UAAU,GAAG;QAChB,MAAM,CAAC,KAAK,CAAC,wBAAwB,EAAE,GAAG,CAAC,CAAA;IAC/C,CAAC;IAED,GAAG,EAAE,UAAU,IAAI;QACf,IAAI;YACA,OAAO,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,cAAc,CAAC,OAAO,CAAC,IAAI,CAAC,CAAA;SAC9C;QAAC,OAAO,GAAG,EAAE;YACV,YAAY,CAAC,KAAK,CAAC,GAAG,CAAC,CAAA;SAC1B;QACD,OAAO,IAAI,CAAA;IACf,CAAC;IAED,KAAK,EAAE,UAAU,IAAI;QACjB,IAAI;YACA,OAAO,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,IAAI,IAAI,CAAA;SACpD;QAAC,OAAO,GAAG,EAAE;YACV,OAAO;SACV;QACD,OAAO,IAAI,CAAA;IACf,CAAC;IAED,GAAG,EAAE,UAAU,IAAI,EAAE,KAAK;QACtB,IAAI;YACA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,cAAc,CAAC,OAAO,CAAC,IAAI,EAAE,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC,CAAA;SAC9D;QAAC,OAAO,GAAG,EAAE;YACV,YAAY,CAAC,KAAK,CAAC,GAAG,CAAC,CAAA;SAC1B;IACL,CAAC;IAED,MAAM,EAAE,UAAU,IAAI;QAClB,IAAI;YACA,MAAM,aAAN,MAAM,uBAAN,MAAM,CAAE,cAAc,CAAC,UAAU,CAAC,IAAI,CAAC,CAAA;SAC1C;QAAC,OAAO,GAAG,EAAE;YACV,YAAY,CAAC,KAAK,CAAC,GAAG,CAAC,CAAA;SAC1B;IACL,CAAC;CACJ,CAAA","sourcesContent":["import { _extend } from './utils'\nimport { PersistentStore, Properties } from './types'\nimport { DISTINCT_ID, SESSION_ID, SESSION_RECORDING_IS_SAMPLED } from './constants'\n\nimport { _isNull, _isUndefined } from './utils/type-utils'\nimport { logger } from './utils/logger'\nimport { window, document } from './utils/globals'\nimport { uuidv7 } from './uuidv7'\n\nconst Y1970 = 'Thu, 01 Jan 1970 00:00:00 GMT'\n// we store the discovered subdomain in memory because it might be read multiple times\nlet firstNonPublicSubDomain = ''\n\n// helper to allow tests to clear this \"cache\"\nexport const resetSubDomainCache = () => {\n    firstNonPublicSubDomain = ''\n}\n\n/**\n * Browsers don't offer a way to check if something is a public suffix\n * e.g. `.com.au`, `.io`, `.org.uk`\n *\n * But they do reject cookies set on public suffixes\n * Setting a cookie on `.co.uk` would mean it was sent for every `.co.uk` site visited\n *\n * So, we can use this to check if a domain is a public suffix\n * by trying to set a cookie on a subdomain of the provided hostname\n * until the browser accepts it\n *\n * inspired by https://github.com/AngusFu/browser-root-domain\n */\nexport function seekFirstNonPublicSubDomain(hostname: string, cookieJar = document): string {\n    if (firstNonPublicSubDomain) {\n        return firstNonPublicSubDomain\n    }\n\n    if (!cookieJar) {\n        return ''\n    }\n    if (['localhost', '127.0.0.1'].includes(hostname)) return ''\n\n    const list = hostname.split('.')\n    let len = Math.min(list.length, 8) // paranoia - we know this number should be small\n    const key = 'dmn_chk_' + uuidv7()\n    const R = new RegExp('(^|;)\\\\s*' + key + '=1')\n\n    while (!firstNonPublicSubDomain && len--) {\n        const candidate = list.slice(len).join('.')\n        const candidateCookieValue = key + '=1;domain=.' + candidate\n\n        // try to set cookie\n        cookieJar.cookie = candidateCookieValue\n\n        if (R.test(cookieJar.cookie)) {\n            // the cookie was accepted by the browser, remove the test cookie\n            cookieJar.cookie = candidateCookieValue + ';expires=' + Y1970\n            firstNonPublicSubDomain = candidate\n        }\n    }\n\n    return firstNonPublicSubDomain\n}\n\nconst DOMAIN_MATCH_REGEX = /[a-z0-9][a-z0-9-]+\\.[a-z]{2,}$/i\nconst originalCookieDomainFn = (hostname: string): string => {\n    const matches = hostname.match(DOMAIN_MATCH_REGEX)\n    return matches ? matches[0] : ''\n}\n\nexport function chooseCookieDomain(hostname: string, cross_subdomain: boolean | undefined): string {\n    if (cross_subdomain) {\n        // NOTE: Could we use this for cross domain tracking?\n        let matchedSubDomain = seekFirstNonPublicSubDomain(hostname)\n\n        if (!matchedSubDomain) {\n            const originalMatch = originalCookieDomainFn(hostname)\n            if (originalMatch !== matchedSubDomain) {\n                logger.info('Warning: cookie subdomain discovery mismatch', originalMatch, matchedSubDomain)\n            }\n            matchedSubDomain = originalMatch\n        }\n\n        return matchedSubDomain ? '; domain=.' + matchedSubDomain : ''\n    }\n    return ''\n}\n\n// Methods partially borrowed from quirksmode.org/js/cookies.html\nexport const cookieStore: PersistentStore = {\n    is_supported: () => !!document,\n\n    error: function (msg) {\n        logger.error('cookieStore error: ' + msg)\n    },\n\n    get: function (name) {\n        if (!document) {\n            return\n        }\n\n        try {\n            const nameEQ = name + '='\n            const ca = document.cookie.split(';').filter((x) => x.length)\n            for (let i = 0; i < ca.length; i++) {\n                let c = ca[i]\n                while (c.charAt(0) == ' ') {\n                    c = c.substring(1, c.length)\n                }\n                if (c.indexOf(nameEQ) === 0) {\n                    return decodeURIComponent(c.substring(nameEQ.length, c.length))\n                }\n            }\n        } catch (err) {}\n        return null\n    },\n\n    parse: function (name) {\n        let cookie\n        try {\n            cookie = JSON.parse(cookieStore.get(name)) || {}\n        } catch (err) {\n            // noop\n        }\n        return cookie\n    },\n\n    set: function (name, value, days, cross_subdomain, is_secure) {\n        if (!document) {\n            return\n        }\n        try {\n            let expires = '',\n                secure = ''\n\n            const cdomain = chooseCookieDomain(document.location.hostname, cross_subdomain)\n\n            if (days) {\n                const date = new Date()\n                date.setTime(date.getTime() + days * 24 * 60 * 60 * 1000)\n                expires = '; expires=' + date.toUTCString()\n            }\n\n            if (is_secure) {\n                secure = '; secure'\n            }\n\n            const new_cookie_val =\n                name +\n                '=' +\n                encodeURIComponent(JSON.stringify(value)) +\n                expires +\n                '; SameSite=Lax; path=/' +\n                cdomain +\n                secure\n\n            // 4096 bytes is the size at which some browsers (e.g. firefox) will not store a cookie, warn slightly before that\n            if (new_cookie_val.length > 4096 * 0.9) {\n                logger.warn('cookieStore warning: large cookie, len=' + new_cookie_val.length)\n            }\n\n            document.cookie = new_cookie_val\n            return new_cookie_val\n        } catch (err) {\n            return\n        }\n    },\n\n    remove: function (name, cross_subdomain) {\n        try {\n            cookieStore.set(name, '', -1, cross_subdomain)\n        } catch (err) {\n            return\n        }\n    },\n}\n\nlet _localStorage_supported: boolean | null = null\n\nexport const localStore: PersistentStore = {\n    is_supported: function () {\n        if (!_isNull(_localStorage_supported)) {\n            return _localStorage_supported\n        }\n\n        let supported = true\n        if (!_isUndefined(window)) {\n            try {\n                const key = '__mplssupport__',\n                    val = 'xyz'\n                localStore.set(key, val)\n                if (localStore.get(key) !== '\"xyz\"') {\n                    supported = false\n                }\n                localStore.remove(key)\n            } catch (err) {\n                supported = false\n            }\n        } else {\n            supported = false\n        }\n        if (!supported) {\n            logger.error('localStorage unsupported; falling back to cookie store')\n        }\n\n        _localStorage_supported = supported\n        return supported\n    },\n\n    error: function (msg) {\n        logger.error('localStorage error: ' + msg)\n    },\n\n    get: function (name) {\n        try {\n            return window?.localStorage.getItem(name)\n        } catch (err) {\n            localStore.error(err)\n        }\n        return null\n    },\n\n    parse: function (name) {\n        try {\n            return JSON.parse(localStore.get(name)) || {}\n        } catch (err) {\n            // noop\n        }\n        return null\n    },\n\n    set: function (name, value) {\n        try {\n            window?.localStorage.setItem(name, JSON.stringify(value))\n        } catch (err) {\n            localStore.error(err)\n        }\n    },\n\n    remove: function (name) {\n        try {\n            window?.localStorage.removeItem(name)\n        } catch (err) {\n            localStore.error(err)\n        }\n    },\n}\n\n// Use localstorage for most data but still use cookie for COOKIE_PERSISTED_PROPERTIES\n// This solves issues with cookies having too much data in them causing headers too large\n// Also makes sure we don't have to send a ton of data to the server\nconst COOKIE_PERSISTED_PROPERTIES = [DISTINCT_ID, SESSION_ID, SESSION_RECORDING_IS_SAMPLED]\n\nexport const localPlusCookieStore: PersistentStore = {\n    ...localStore,\n    parse: function (name) {\n        try {\n            let extend: Properties = {}\n            try {\n                // See if there's a cookie stored with data.\n                extend = cookieStore.parse(name) || {}\n            } catch (err) {}\n            const value = _extend(extend, JSON.parse(localStore.get(name) || '{}'))\n            localStore.set(name, value)\n            return value\n        } catch (err) {\n            // noop\n        }\n        return null\n    },\n\n    set: function (name, value, days, cross_subdomain, is_secure) {\n        try {\n            localStore.set(name, value)\n            const cookiePersistedProperties: Record<string, any> = {}\n            COOKIE_PERSISTED_PROPERTIES.forEach((key) => {\n                if (value[key]) {\n                    cookiePersistedProperties[key] = value[key]\n                }\n            })\n\n            if (Object.keys(cookiePersistedProperties).length) {\n                cookieStore.set(name, cookiePersistedProperties, days, cross_subdomain, is_secure)\n            }\n        } catch (err) {\n            localStore.error(err)\n        }\n    },\n\n    remove: function (name, cross_subdomain) {\n        try {\n            window?.localStorage.removeItem(name)\n            cookieStore.remove(name, cross_subdomain)\n        } catch (err) {\n            localStore.error(err)\n        }\n    },\n}\n\nconst memoryStorage: Properties = {}\n\n// Storage that only lasts the length of the pageview if we don't want to use cookies\nexport const memoryStore: PersistentStore = {\n    is_supported: function () {\n        return true\n    },\n\n    error: function (msg) {\n        logger.error('memoryStorage error: ' + msg)\n    },\n\n    get: function (name) {\n        return memoryStorage[name] || null\n    },\n\n    parse: function (name) {\n        return memoryStorage[name] || null\n    },\n\n    set: function (name, value) {\n        memoryStorage[name] = value\n    },\n\n    remove: function (name) {\n        delete memoryStorage[name]\n    },\n}\n\nlet sessionStorageSupported: boolean | null = null\nexport const resetSessionStorageSupported = () => {\n    sessionStorageSupported = null\n}\n// Storage that only lasts the length of a tab/window. Survives page refreshes\nexport const sessionStore: PersistentStore = {\n    is_supported: function () {\n        if (!_isNull(sessionStorageSupported)) {\n            return sessionStorageSupported\n        }\n        sessionStorageSupported = true\n        if (!_isUndefined(window)) {\n            try {\n                const key = '__support__',\n                    val = 'xyz'\n                sessionStore.set(key, val)\n                if (sessionStore.get(key) !== '\"xyz\"') {\n                    sessionStorageSupported = false\n                }\n                sessionStore.remove(key)\n            } catch (err) {\n                sessionStorageSupported = false\n            }\n        } else {\n            sessionStorageSupported = false\n        }\n        return sessionStorageSupported\n    },\n\n    error: function (msg) {\n        logger.error('sessionStorage error: ', msg)\n    },\n\n    get: function (name) {\n        try {\n            return window?.sessionStorage.getItem(name)\n        } catch (err) {\n            sessionStore.error(err)\n        }\n        return null\n    },\n\n    parse: function (name) {\n        try {\n            return JSON.parse(sessionStore.get(name)) || null\n        } catch (err) {\n            // noop\n        }\n        return null\n    },\n\n    set: function (name, value) {\n        try {\n            window?.sessionStorage.setItem(name, JSON.stringify(value))\n        } catch (err) {\n            sessionStore.error(err)\n        }\n    },\n\n    remove: function (name) {\n        try {\n            window?.sessionStorage.removeItem(name)\n        } catch (err) {\n            sessionStore.error(err)\n        }\n    },\n}\n"]}